# Tutoriel : librairie en Julia

*Ce guide pr√©sente les √©tapes pour creÃÅer une librairie Julia de A aÃÄ Z, c'est-√†-dire toutes les eÃÅtapes permettant d‚Äôavoir un projet complet de qualiteÃÅ professionnelle !* üëÄ

#### Table des mati√®res
1. [Structure de base](#1-structure-de-base)
2. [D√©veloppement de la librairie](#2-d√©veloppement-de-la-librairie)
3. [Tests](#3-tests)
4. [Int√©gration continue](#4-int√©gration-continue)
5. [Documentation](#5-documentation)
6. [Enregistrement au registre de Julia](#6-enregistrement-au-registre-de-julia)

---

## 1. Structure de base

### Configuration de git

Avant de proc√©der √† la cr√©ation de notre librarie Julia, on va configurer `git` pour y ajouter nos informations personelles. 

On v√©rifie d'abord que `git` est bien install√© en regardant sa version :

```bash
$ git --version
```

Ensuite, la commande `config --list` permet de lister notre configuration actuelle :

```bash
$ git config --list
```

Puis, pour y ajouter notre nom et notre courriel, on entre les commandes suivantes : 

```bash
$ git config --global user.name "Gabriel Gobeil"
$ git config --global user.email gabriel.gobeil199@gmail.com
```

### G√©n√©ration d'une librairie de base avec Pkg

Il existe une fonction dans `Pkg` qui permet de g√©n√©rer facilement la structure de base d'une librairie Julia. On va s'en servir pour cr√©er une libraire bidon appel√©e `NewPackage.jl` pour l'exemple : 

```julia
julia> ]
pkg> generate NewPackage.jl
```

Cela va cr√©er la structure de base suivante :

```
NewPackage.jl/
‚îú‚îÄ‚îÄ Project.toml
‚îî‚îÄ‚îÄ src
    ‚îî‚îÄ‚îÄ NewPackage.jl
```

o√π `src/NewPackage.jl` est le fichier de module et `Project.toml` le fichier de configuration de la librairie.

Ce dernier fichier contient le nom de la librairie, son num√©ro d'identification unique, son num√©ro de version ainsi que les informations sur l'auteur, obtenus √† partir de votre configuration `git` :

```
name = "NewPackage"
uuid = "11071f02-195a-4744-98d5-929847dbbb65"
authors = ["Gabriel Gobeil <gabriel.gobeil199@gmail.com>"]
version = "0.1.0"
```

Plus tard, lorsqu'on ajoutera des d√©pendances √† notre librairie, elles seront list√©es dans ce fichier.

Le fichier de module `src/NewPackage.jl` va √™tre celui o√π on charge les d√©pendances, inclut les fichiers de fonctions et exporte les fonctions de notre librairie. Pour le moment, il ne contient qu'une fonction `greet()` g√©n√©r√©e par d√©faut par `Pkg` :

```
module NewPackage

greet() = print("Hello World!")

end # module NewPackage
```

On peut tester cette fonction en chargeant notre librairie. Puisqu'elle n'est pas encore install√©e, il faut activer son environnement avant de la charger :

```julia
julia> ]
pkg> activate .
julia> using NewPackage
```

Puisque la fonction `greet()` n'est pas export√©e, il faut ajouter le nom de la librairie devant lorsqu'on l'appelle :

```julia
julia> NewPackage.greet()
```


### Suivi des modifications avec `git`

#### Initialisation 

Pour activer le suivi des modifications avec `git`, il faut que `git` soit initialis√© dans le r√©pertoire de la librairie :

```bash
$ git init
```

Cela va cr√©er un dossier cach√© `.git` n√©cessaire √† `git`.

```
$ git status
```

#### Premier commit

On doit ajouter et commiter nos fichiers :

```bash
$ git add src/NewPackage.jl
$ git add Project.toml
$ git commit -m "Ajout des fichiers"
```

Les changements apport√©s devraient √™tre visibles par `git` :

```
$ git status
```

La description du changement peut √™tre lue dans le log :

```
$ git log
```

### Synchronisation des changements avec GitHub

On aimerait pouvoir envoyer nos fichiers vers GitHub pour les partager avec le monde. Avant cela, il faut configurer notre compte pour qu'il reconnaisse notre ordinateur.

#### G√©n√©ration de la cl√© SSH

On g√©n√®re une cl√© SSH :

```bash
$ ssh-keygen -t ed25519 -C "gabriel.gobeil199@gmail.com"
$ eval "$(ssh-agent -s)"
$ ssh-add --apple-use-keychain ~/.ssh/id_ed25519
```

On copie la cl√© dans notre presse-papier afin de la recopier dans le champ appropri√© sur GitHub :

```bash
$ pbcopy < ~/.shh/id_ed25519.pub
```

#### Configuration sur *GitHub.com*

On doit se rendre sur GitHub dans les param√®tres √† la section **SSH and GPG keys** : [https://github.com/settings/keys](https://github.com/settings/keys).

On clique sur le bouton vert √† droite *New SSH key* puis on nomme la cl√© (p. ex., *mac-gab*), colle le contenu du presse-papier dans le champ **key** et clique sur le bouton vert *Add SSH key*.

#### Cr√©ation du d√©pot √† distance 

Maintenant que la cl√© SSH de notre ordinateur est li√© √† notre compte GitHub, on va cr√©er le r√©pertoire associ√© √† notre librairie en se rendant sur [https://github.com/new](https://github.com/new).

Dans le champ **Repository name**, on va entrer le nom de notre librairie : *NewPackage.jl*.

Puisqu'on va syncroniser un r√©pertoire existant, on laisse la section **Initialize this repository with:** vide, on va ajouter le fichier README plus tard.

Une fois le r√©pertoire cr√©√© sur GitHub, on peut syncroniser notre d√©p√¥t local avec celui √† distance :

```bash
$ git remote add origin git@github.com:houton199/NewPackage.jl.git
$ git push -u origin master
```

---
## 2. D√©veloppement de la librairie

On a maintenant la librairie Julia la plus basique qui soit, libre √† nous de la d√©velopper √† notre guise ! Dans cet exemple, nous allons ajouter le fichier *README* et des d√©pendances √† notre librairie.

### Ajout du README

L'ajout d'un *README* va permettre de d√©crire notre librairie √† ses potentiels utilisateurs. On va cr√©er le fichier README.md √† m√™me le terminal avec `touch` puis utiliser l'√©diteur `vi` pour le remplir :

```bash
$ touch README.md
$ vi README.md
```

Dans l'√©diteur `vi`, pour √©crire du texte, on doit entrer de le mode insertion avec la touche <kbd>i</kbd>.

On ajoute quelques lignes pour d√©crire le projet :

```
# NewPackage.jl

Une librairie Julia exemplaire...
```

On peut aussi ajouter un [badge](https://www.repostatus.org/) pour l‚ÄôeÃÅtat du projet : [![Project Status: WIP ‚Äì Initial development is in progress, but there has not yet been a stable, usable release suitable for the public.](https://www.repostatus.org/badges/latest/wip.svg)](https://www.repostatus.org/#wip)

```
# NewPackage.jl

[![Project Status: WIP ‚Äì Initial development is in progress, but there has not yet been a stable, usable release suitable for the public.](https://www.repostatus.org/badges/latest/wip.svg)](https://www.repostatus.org/#wip)

Une librairie Julia exemplaire...
```





Pour quitter `vi`, il faut quitter le mode insertion avec <kbd>ESC</kbd> et taper `:wq` + <kbd>Enter</kbd> (w pour *write*, q pour *quit*).


#### Commit et synchronisation avec le d√©p√¥t √† distance

Une fois qu'on est satisfait des ajouts au *README*, on peut faire un commit et l'envoyer sur GitHub :

```bash
$ git add README.md
$ git commit -m "Ajout du README"
$ git push origin master
```

Notez qu'on n'a plus besoin du `-u` ici car la branche existe d√©j√† sur le r√©pertoire distant.

### Ajout de d√©pendances

On va ajouter des d√©pendances √† notre librairie en les installant dans son environnement.

#### Activation de l'environnement 

Pour activer l'environnement de notre librairie avec `Pkg`, on utilise la fonction `activate` :

```julia
julia> ]
pkg> activate .
```

On peut v√©rifier qu'on est dans le bon environnement avec `status` :

```julia
pkg> status
```

Il devrait √™tre √©crit qu'on se trouve dans `Project NewPackage v0.1.0`. Puisqu'aucune d√©pendance n'est install√©e pour le moment, la liste est vide.

#### Installation des d√©pendances

Les d√©pendances s'ajoutent de la m√™me fa√ßon qu'on installe n'importe quelle librairie Julia avec `Pkg` :

```julia
pkg> add Distributions
```

Une fois la librairie install√©e, on peut aller voir si elle se trouve dans le fichier de projet `Project.toml` :

```
name = "NewPackage"
uuid = "11071f02-195a-4744-98d5-929847dbbb65"
authors = ["Gabriel Gobeil <gabriel.gobeil199@gmail.com>"]
version = "0.1.0"

[deps]
Distributions = "31c24e10-a181-5473-b8eb-7969acd0382f"
```


#### Commit et synchronisation avec le d√©p√¥t √† distance

Une fois qu'on est satisfait des ajouts, on peut faire un commit et l'envoyer sur GitHub :

```bash
$ git add README.md
$ git commit -m "Ajout de Distributions.jl"
$ git push origin master
```

### Ajout d'un fichier de fonctions

Pour l'instant, notre librairie n'est constitu√©e que du fichier `src/NewPackage.jl`. Nous allons cr√©er le fichier de fonction `functions.jl`et l'ajouter √† la librairie :

```
$ touch src/functions.jl
```

On va l'ouvrir dans l'√©diteur `vi` et y d√©placer la fonction `greet()` contenue dans `src/NewPackage.jl`.

Le fichier `src/functions.jl` devrait ressembler √† √ßa :

```
greet() = print("Hello World!")
```

et le fichier `src/NewPackage.jl` √† √ßa :

```
module NewPackage

end # module NewPackage
```

#### Inclure des fichiers au module

Pour inclure le nouveau fichier `functions.jl` √† notre librairie, on va l'ajouter au module avec `include()`:

```
module NewPackage

include("functions.jl");

end # module NewPackage
```

#### Exporter des fonctions

On peut exporter la fonction `greet()` pour y avoir acc√®s sans devoir √©crire `NewPackage.` devant √† chaque fois :

```
module NewPackage

include("functions.jl");

export greet

end # module NewPackage
```

#### Charger des d√©pendances

C'est aussi dans ce fichier qu'on doit charger les d√©pendances si n√©cessaire :

```
module NewPackage

using Distributions

include("functions.jl");

export greet

end # module NewPackage
```

*Pour un exemple de comment structurer le r√©pertoire source d'une librairie Julia, on peut s'inspirer de la structure d'[Extremes.jl](https://github.com/jojal5/Extremes.jl/tree/master/src) et de son fichier de [module](https://github.com/jojal5/Extremes.jl/blob/master/src/Extremes.jl).*

#### Commit et synchronisation avec le d√©p√¥t √† distance

Une fois qu'on est satisfait des ajouts, on peut faire un commit et l'envoyer sur GitHub :

```bash
$ git add src/functions.jl
$ git commit -m "Ajout du fichier de fonctions"
$ git push origin master
```

---
## 3. Tests

Pour augmenter la confiance envers notre nouvelle librairie Julia, il est important de tester ses fonctionnaliteÃÅs.

La bonne pratique suggeÃÄre *une fonction, un test*. On peut ainsi structurer nos tests de facÃßon miroir avec la structure des fonctions.

On va creÃÅer un dossier *test* avec le fichier *runtests.jl* qui va inclure le fichier de test pour le fichier *functions.jl*.

```
NewPackage.jl/
‚îú‚îÄ‚îÄ Project.toml
‚îú‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ src
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ NewPackage.jl
‚îî‚îÄ‚îÄ test
    ‚îú‚îÄ‚îÄ functions_test.jl
    ‚îî‚îÄ‚îÄ runtests.jl
```

Il ne faut pas oublier d‚Äôinclure la libraire Test au fichier de projet.
 

---
## 4. Int√©gration continue

On aimerait automatiser le processus de test pour veÃÅrifier que l‚Äôajout de nouvelles fonctionnaliteÃÅs √† notre librairie ne viennent pas tout briser. EÃÅgalement, cÃßa serait inteÃÅressant d‚Äôafficher le taux de couverture de notre librairie, soit le pourcentage de ligne de code qui est couvert par des tests.

### GitHub Workflows

On va se servir de GitHub pour lancer des processus automatiques qui vont nous informer si la librairie compile (*build status*) et quel est sa couverture avec Codecov.

On doit d‚Äôabord creÃÅer un nouveau dossier cacheÃÅ `.github` dans lequel on va ajouter le dossier `workflows`. Ce dossier va √™tre celui dans lequel on place les instructions pour dire aÃÄ GitHub quoi faire lorsqu‚Äôon push quelque chose de nouveau sur une branche de notre reÃÅpertoire.

```
$ mkdir -p .github/workflows
```

On va y inseÃÅrer le fichier d‚Äôinstructions `ci.yml` :

```
$ touch .github/workflows/ci.yml
```

Ici, je vais reprendre les instructions deÃÅjaÃÄ eÃÅcrites pour Extremes.jl mais les instructions sont relativement simple aÃÄ comprendre.


```
name: CI
on:
  pull_request:
    branches:
      - master
      - dev
  push:
    branches:
      - master
      - rm_Manifest_toml
    tags: '*'
jobs:
  test:
    name: Julia ${{ matrix.version }} - ${{ matrix.os }} - ${{ matrix.arch }} - ${{ github.event_name }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        version:
          - '1'
        os:
          - ubuntu-latest
        arch:
          - x64
    steps:
      - uses: actions/checkout@v2
      - uses: julia-actions/setup-julia@v1
        with:
          version: ${{ matrix.version }}
          arch: ${{ matrix.arch }}
      - uses: actions/cache@v1
        env:
          cache-name: cache-artifacts
        with:
          path: ~/.julia/artifacts
          key: ${{ runner.os }}-test-${{ env.cache-name }}-${{ hashFiles('**/Project.toml') }}
          restore-keys: |
            ${{ runner.os }}-test-${{ env.cache-name }}-
            ${{ runner.os }}-test-
            ${{ runner.os }}-
      - uses: julia-actions/julia-buildpkg@v1
      - uses: julia-actions/julia-runtest@v1
      - uses: julia-actions/julia-processcoverage@v1
      - uses: codecov/codecov-action@v2
```

### Couverture de code avec CodeCov

- Pour avoir la couverture avec Codecov, on doit installer l‚Äôapplication dans le reÃÅpertoire.
- Pour des librairies publiques, c‚Äôest pratiquement tout ce qu‚Äôil a faire.
- Ici, puisque c‚Äôest priveÃÅ, on va devoir teÃÅleÃÅverser le rapport sur Codecov pour obtenir les statistiques.
- On fait l‚Äôajout des instructions pour le teÃÅleÃÅversement au fichier CI.yml.
- Une fois que les tests sont passeÃÅs, le rapport est disponible sur codecov.io.


---
## 5. Documentation

Maintenant que notre librairie est sur GitHub et qu‚Äôelle est testeÃÅe, nous pouvons ajouter de la documentation pour aider les potentiels utilisateurs aÃÄ s‚Äôen servir. Pour ce faire, nous allons utiliser la librairie *[Documenter.jl](https://github.com/JuliaDocs/Documenter.jl)*.

### Structure

On va construire la structure de la documentation dans notre reÃÅpertoire en creÃÅant d‚Äôabord un dossier `docs` dans lequel on va ajouter le dossier `src`, qui va eÃÇtre le dossier dans lequel on va eÃÅcrire la documentation, et un fichier `make.jl`, qui est le script julia qui va geÃÅneÃÅrer la documentation.

---
## 6. Enregistrement au registre de Julia

- https://github.com/JuliaRegistries/Registrator.jl
